machine:
  java:
    version: oraclejdk8

dependencies:
  cache_directories:
    - "~/.stack"
    - ".stack-work"

  pre:
    - sudo apt-get --quiet update
    - sudo apt-get --quiet install rsync texlive-latex-base texlive-latex-extra
    - sudo pip install html5validator

  override:
    - (curl -sSL https://get.haskellstack.org/ | sh) || true
    - stack upgrade
    - stack --version
    - stack setup
    - stack build

test:
  override:
    - stack test
    - stack exec mk-com -- clean
    - pdflatex -output-directory resume/ resume/resume.tex
    - stack exec mk-com
    - html5validator --root _build/ --show-warnings

deployment:
  production:
    branch: master
    commands:
      - stack exec mk-com
      - rsync -avz -e "ssh -p 2555 -i $HOME/.ssh/id_circleci_github" _build/ admin@markkarpov.com:/home/admin/markkarpov.com
